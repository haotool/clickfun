<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Click Fun å¿«å–æ¸¬è©¦å·¥å…·</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #f66fb9 0%, #52b7ff 100%);
        min-height: 100vh;
      }

      .container {
        background: white;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }

      .test-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 2px solid #f0f0f0;
        border-radius: 12px;
      }

      .test-section h3 {
        color: #f66fb9;
        margin-top: 0;
      }

      button {
        background: linear-gradient(135deg, #f66fb9 0%, #52b7ff 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        margin: 5px;
        transition: transform 0.2s;
      }

      button:hover {
        transform: translateY(-2px);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .log {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        max-height: 300px;
        overflow-y: auto;
      }

      .status {
        padding: 10px;
        border-radius: 6px;
        margin: 10px 0;
        font-weight: 600;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ§ª Click Fun å¿«å–æ¸¬è©¦å·¥å…·</h1>

      <div class="test-section">
        <h3>ğŸ“¦ å¿«å–ç®¡ç†æ¸¬è©¦</h3>
        <button onclick="listCaches()">åˆ—å‡ºæ‰€æœ‰å¿«å–</button>
        <button onclick="createTestCaches()">å‰µå»ºæ¸¬è©¦å¿«å–</button>
        <button onclick="clearOldCaches()">æ¸…é™¤èˆŠå¿«å–</button>
        <button onclick="clearAllCaches()">æ¸…é™¤æ‰€æœ‰å¿«å–</button>
      </div>

      <div class="test-section">
        <h3>ğŸ”„ ç‰ˆæœ¬æ›´æ–°æ¸¬è©¦</h3>
        <button onclick="simulateVersionUpdate()">æ¨¡æ“¬ç‰ˆæœ¬æ›´æ–°</button>
        <button onclick="checkVersion()">æª¢æŸ¥ç•¶å‰ç‰ˆæœ¬</button>
        <button onclick="resetVersion()">é‡ç½®ç‰ˆæœ¬</button>
      </div>

      <div class="test-section">
        <h3>ğŸ§ª è‡ªå‹•åŒ–æ¸¬è©¦</h3>
        <button onclick="runFullTest()">åŸ·è¡Œå®Œæ•´æ¸¬è©¦</button>
        <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
      </div>

      <div id="status"></div>
      <div id="log" class="log"></div>
    </div>

    <script src="test-cache-clear.js"></script>
    <script>
      const APP_VERSION = '7.0.0';

      function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logElement = document.getElementById('log');
        const statusElement = document.getElementById('status');

        const logMessage = `[${timestamp}] ${message}`;
        logElement.innerHTML += logMessage + '\n';
        logElement.scrollTop = logElement.scrollHeight;

        // æ›´æ–°ç‹€æ…‹
        statusElement.innerHTML = `<div class="status ${type}">${message}</div>`;

        console.log(logMessage);
      }

      async function listCaches() {
        try {
          const cacheNames = await caches.keys();
          log(`ğŸ“‹ æ‰¾åˆ° ${cacheNames.length} å€‹å¿«å–:`);
          cacheNames.forEach(name => log(`  - ${name}`));

          if (cacheNames.length === 0) {
            log('æ²’æœ‰æ‰¾åˆ°ä»»ä½•å¿«å–', 'info');
          }
        } catch (error) {
          log(`âŒ åˆ—å‡ºå¿«å–å¤±æ•—: ${error.message}`, 'error');
        }
      }

      async function createTestCaches() {
        try {
          const testCaches = [
            'clickfun-v7.0.0',
            'clickfun-v7.0.0',
            'clickfun-v6.1.0',
            'old-test-cache',
          ];

          log('ğŸ“¦ å‰µå»ºæ¸¬è©¦å¿«å–...');

          for (const cacheName of testCaches) {
            const cache = await caches.open(cacheName);
            await cache.put('/test', new Response(`Test data for ${cacheName}`));
            log(`  âœ… å‰µå»ºå¿«å–: ${cacheName}`);
          }

          log('âœ… æ‰€æœ‰æ¸¬è©¦å¿«å–å‰µå»ºå®Œæˆ', 'success');
        } catch (error) {
          log(`âŒ å‰µå»ºæ¸¬è©¦å¿«å–å¤±æ•—: ${error.message}`, 'error');
        }
      }

      async function clearOldCaches() {
        try {
          const cacheNames = await caches.keys();
          const currentCachePatterns = [
            `clickfun-v${APP_VERSION}`,
            'clickfun-enhanced-v1.1.0-app-shell',
            'clickfun-enhanced-v1.1.0-static',
            'clickfun-enhanced-v1.1.0-dynamic',
            'clickfun-enhanced-v1.1.0-images',
          ];

          log(`ğŸ—‘ï¸ æ¸…é™¤èˆŠå¿«å– (ä¿ç•™ç•¶å‰ç‰ˆæœ¬å¿«å–)...`);

          let clearedCount = 0;
          for (const cacheName of cacheNames) {
            if (!currentCachePatterns.includes(cacheName)) {
              await caches.delete(cacheName);
              log(`  ğŸ—‘ï¸ å·²æ¸…é™¤: ${cacheName}`);
              clearedCount++;
            } else {
              log(`  âœ… ä¿ç•™: ${cacheName}`);
            }
          }

          if (clearedCount > 0) {
            log(`âœ… æ¸…é™¤äº† ${clearedCount} å€‹èˆŠå¿«å–`, 'success');
          } else {
            log('â„¹ï¸ æ²’æœ‰éœ€è¦æ¸…é™¤çš„èˆŠå¿«å–', 'info');
          }
        } catch (error) {
          log(`âŒ æ¸…é™¤èˆŠå¿«å–å¤±æ•—: ${error.message}`, 'error');
        }
      }

      async function clearAllCaches() {
        try {
          const cacheNames = await caches.keys();
          log(`ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰å¿«å– (${cacheNames.length} å€‹)...`);

          for (const cacheName of cacheNames) {
            await caches.delete(cacheName);
            log(`  ğŸ—‘ï¸ å·²æ¸…é™¤: ${cacheName}`);
          }

          log('âœ… æ‰€æœ‰å¿«å–å·²æ¸…é™¤', 'success');
        } catch (error) {
          log(`âŒ æ¸…é™¤æ‰€æœ‰å¿«å–å¤±æ•—: ${error.message}`, 'error');
        }
      }

      function simulateVersionUpdate() {
        const oldVersion = '7.0.0';
        localStorage.setItem('app_version', oldVersion);
        log(`ğŸ”„ æ¨¡æ“¬ç‰ˆæœ¬æ›´æ–°: ${oldVersion} â†’ ${APP_VERSION}`);
        log('ğŸ’¡ é‡æ–°è¼‰å…¥é é¢ä»¥è§¸ç™¼ç‰ˆæœ¬æª¢æ¸¬', 'info');
      }

      function checkVersion() {
        const storedVersion = localStorage.getItem('app_version');
        log(`ğŸ“‹ ç•¶å‰ç‰ˆæœ¬è³‡è¨Š:`);
        log(`  - æ‡‰ç”¨ç‰ˆæœ¬: ${APP_VERSION}`);
        log(`  - å„²å­˜ç‰ˆæœ¬: ${storedVersion || 'æœªè¨­å®š'}`);

        if (storedVersion !== APP_VERSION) {
          log('âš ï¸ ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œéœ€è¦æ›´æ–°', 'info');
        } else {
          log('âœ… ç‰ˆæœ¬ä¸€è‡´', 'success');
        }
      }

      function resetVersion() {
        localStorage.removeItem('app_version');
        log('ğŸ”„ ç‰ˆæœ¬è³‡è¨Šå·²é‡ç½®');
      }

      async function runFullTest() {
        log('ğŸ§ª é–‹å§‹åŸ·è¡Œå®Œæ•´æ¸¬è©¦...');

        try {
          // 1. å‰µå»ºæ¸¬è©¦å¿«å–
          await createTestCaches();
          await new Promise(resolve => setTimeout(resolve, 1000));

          // 2. åˆ—å‡ºå¿«å–
          await listCaches();
          await new Promise(resolve => setTimeout(resolve, 1000));

          // 3. æ¨¡æ“¬ç‰ˆæœ¬æ›´æ–°
          simulateVersionUpdate();
          await new Promise(resolve => setTimeout(resolve, 1000));

          // 4. æ¸…é™¤èˆŠå¿«å–
          await clearOldCaches();
          await new Promise(resolve => setTimeout(resolve, 1000));

          // 5. æœ€çµ‚æª¢æŸ¥
          await listCaches();

          log('ğŸ‰ å®Œæ•´æ¸¬è©¦åŸ·è¡Œå®Œæˆï¼', 'success');
        } catch (error) {
          log(`âŒ å®Œæ•´æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
        }
      }

      function clearLog() {
        document.getElementById('log').innerHTML = '';
        document.getElementById('status').innerHTML = '';
      }

      // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
      window.addEventListener('load', () => {
        log('ğŸš€ å¿«å–æ¸¬è©¦å·¥å…·å·²è¼‰å…¥');
        checkVersion();
      });
    </script>
  </body>
</html>
