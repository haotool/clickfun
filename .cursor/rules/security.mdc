---
description: "å®‰å…¨æ€§è¦æ±‚ - éŠæˆ²å®‰å…¨èˆ‡è³‡æ–™ä¿è­·"
type: "Auto Attached"
pattern: "**/*.{js,jsx,ts,tsx,html}"
version: "1.0.0"
author: "s123104"
last_updated: "2025-08-16T18:22:20+08:00"
---

# Click Fun å®‰å…¨æ€§è¦ç¯„

## ğŸ”’ å®‰å…¨æ€§åŸå‰‡

åŸºæ–¼ **é›¶ä¿¡ä»»æ¶æ§‹** å’Œ **OWASP Top 10** æœ€ä½³å¯¦è¸ï¼Œç¢ºä¿éŠæˆ²å®‰å…¨æ€§ã€‚

### æ ¸å¿ƒå®‰å…¨åŸå‰‡

```yaml
security_principles:
  data_validation: "æ‰€æœ‰è¼¸å…¥éƒ½æ˜¯æƒ¡æ„çš„ï¼Œç›´åˆ°è­‰æ˜ç‚ºæ­¢"
  least_privilege: "æœ€å°æ¬Šé™åŸå‰‡"
  defense_in_depth: "å¤šå±¤å®‰å…¨é˜²è­·"
  fail_secure: "å®‰å…¨å¤±æ•—æ¨¡å¼"
  zero_trust: "é›¶ä¿¡ä»»æ¶æ§‹"
```

## ğŸ›¡ï¸ å‰ç«¯å®‰å…¨è¦æ±‚

### è¼¸å…¥é©—è­‰èˆ‡æ¸…ç†

```javascript
// âœ… åš´æ ¼çš„è¼¸å…¥é©—è­‰
class SecurityValidator {
  /**
   * é©—è­‰åˆ†æ•¸è¼¸å…¥
   * @param {any} score - å¾…é©—è­‰çš„åˆ†æ•¸
   * @returns {number} é©—è­‰å¾Œçš„åˆ†æ•¸
   */
  static validateScore(score) {
    // å‹åˆ¥é©—è­‰
    if (typeof score !== 'number') {
      throw new SecurityError('INVALID_SCORE_TYPE', 'åˆ†æ•¸å¿…é ˆæ˜¯æ•¸å­—');
    }
    
    // ç¯„åœé©—è­‰
    if (!Number.isFinite(score) || Number.isNaN(score)) {
      throw new SecurityError('INVALID_SCORE_VALUE', 'åˆ†æ•¸å¿…é ˆæ˜¯æœ‰æ•ˆæ•¸å­—');
    }
    
    // åˆç†æ€§æª¢æŸ¥ï¼ˆé˜²æ­¢ä½œå¼Šï¼‰
    const MAX_REASONABLE_SCORE = 1000;
    if (score > MAX_REASONABLE_SCORE) {
      SecurityLogger.logSuspiciousActivity('UNREASONABLE_SCORE', {
        score,
        timestamp: Date.now(),
        userAgent: navigator.userAgent
      });
      throw new SecurityError('SCORE_TOO_HIGH', 'åˆ†æ•¸è¶…å‡ºåˆç†ç¯„åœ');
    }
    
    if (score < 0) {
      throw new SecurityError('NEGATIVE_SCORE', 'åˆ†æ•¸ä¸èƒ½ç‚ºè² æ•¸');
    }
    
    return Math.floor(score); // ç¢ºä¿ç‚ºæ•´æ•¸
  }
  
  /**
   * æ¸…ç†ç”¨æˆ¶è¼¸å…¥
   * @param {string} input - åŸå§‹è¼¸å…¥
   * @returns {string} æ¸…ç†å¾Œçš„å®‰å…¨è¼¸å…¥
   */
  static sanitizeInput(input) {
    if (typeof input !== 'string') {
      return '';
    }
    
    return input
      // ç§»é™¤ HTML æ¨™ç±¤
      .replace(/<[^>]*>/g, '')
      // ç§»é™¤ JavaScript å”è­°
      .replace(/javascript:/gi, '')
      // ç§»é™¤ data: å”è­°
      .replace(/data:/gi, '')
      // ç§»é™¤ç‰¹æ®Šå­—ç¬¦
      .replace(/[<>'"&]/g, '')
      // é™åˆ¶é•·åº¦
      .substring(0, 200)
      .trim();
  }
}

// âŒ å±éšªçš„ç›´æ¥ä½¿ç”¨
function updatePlayerName(name) {
  document.getElementById('playerName').innerHTML = name; // XSS é¢¨éšª
}

// âœ… å®‰å…¨çš„ä½¿ç”¨æ–¹å¼
function updatePlayerName(name) {
  const sanitizedName = SecurityValidator.sanitizeInput(name);
  document.getElementById('playerName').textContent = sanitizedName;
}
```

### XSS é˜²è­·

```javascript
// âœ… é˜² XSS çš„ DOM æ“ä½œ
class SafeDOM {
  /**
   * å®‰å…¨è¨­å®šå…ƒç´ å…§å®¹
   * @param {HTMLElement} element - ç›®æ¨™å…ƒç´ 
   * @param {string} content - å…§å®¹
   */
  static setTextContent(element, content) {
    if (!element || typeof content !== 'string') return;
    
    // ä½¿ç”¨ textContent è€Œé innerHTML
    element.textContent = SecurityValidator.sanitizeInput(content);
  }
  
  /**
   * å®‰å…¨è¨­å®šå±¬æ€§
   * @param {HTMLElement} element - ç›®æ¨™å…ƒç´ 
   * @param {string} attribute - å±¬æ€§åç¨±
   * @param {string} value - å±¬æ€§å€¼
   */
  static setAttribute(element, attribute, value) {
    if (!element || typeof attribute !== 'string') return;
    
    // ç™½åå–®å±¬æ€§
    const allowedAttributes = [
      'class', 'id', 'data-score', 'data-player',
      'aria-label', 'role', 'tabindex'
    ];
    
    if (!allowedAttributes.includes(attribute)) {
      console.warn(`å±¬æ€§ ${attribute} ä¸åœ¨ç™½åå–®ä¸­`);
      return;
    }
    
    const sanitizedValue = SecurityValidator.sanitizeInput(value);
    element.setAttribute(attribute, sanitizedValue);
  }
}
```

### CSP (Content Security Policy) é…ç½®

```html
<!-- âœ… åš´æ ¼çš„ CSP è¨­å®š -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline' https://www.googletagmanager.com;
  style-src 'self' 'unsafe-inline';
  img-src 'self' data: https:;
  font-src 'self';
  connect-src 'self' https://api.github.com;
  worker-src 'self';
  manifest-src 'self';
  frame-ancestors 'none';
  base-uri 'self';
  form-action 'self';
">
```

## ğŸ—ƒï¸ è³‡æ–™å®‰å…¨

### LocalStorage å®‰å…¨ä½¿ç”¨

```javascript
// âœ… å®‰å…¨çš„è³‡æ–™å„²å­˜
class SecureStorage {
  static ENCRYPTION_KEY = 'clickfun-secure-key';
  
  /**
   * å®‰å…¨å„²å­˜éŠæˆ²è³‡æ–™
   * @param {string} key - å„²å­˜éµå€¼
   * @param {any} data - è¦å„²å­˜çš„è³‡æ–™
   */
  static setItem(key, data) {
    try {
      // é©—è­‰éµå€¼
      if (typeof key !== 'string' || key.length === 0) {
        throw new SecurityError('INVALID_STORAGE_KEY', 'ç„¡æ•ˆçš„å„²å­˜éµå€¼');
      }
      
      // é©—è­‰è³‡æ–™
      const validatedData = this.validateStorageData(data);
      
      // æ·»åŠ æ™‚é–“æˆ³å’Œç‰ˆæœ¬è³‡è¨Š
      const storageObject = {
        data: validatedData,
        timestamp: Date.now(),
        version: '7.1.1',
        checksum: this.calculateChecksum(validatedData)
      };
      
      // åºåˆ—åŒ–ä¸¦å„²å­˜
      const serialized = JSON.stringify(storageObject);
      localStorage.setItem(`clickfun_${key}`, serialized);
      
    } catch (error) {
      SecurityLogger.logStorageError('SET_ITEM_FAILED', { key, error: error.message });
      throw error;
    }
  }
  
  /**
   * å®‰å…¨è®€å–éŠæˆ²è³‡æ–™
   * @param {string} key - å„²å­˜éµå€¼
   * @returns {any} è®€å–çš„è³‡æ–™
   */
  static getItem(key) {
    try {
      const rawData = localStorage.getItem(`clickfun_${key}`);
      if (!rawData) return null;
      
      const storageObject = JSON.parse(rawData);
      
      // é©—è­‰è³‡æ–™å®Œæ•´æ€§
      if (!this.verifyChecksum(storageObject.data, storageObject.checksum)) {
        SecurityLogger.logSecurityEvent('DATA_INTEGRITY_VIOLATION', { key });
        throw new SecurityError('DATA_CORRUPTION', 'è³‡æ–™å®Œæ•´æ€§é©—è­‰å¤±æ•—');
      }
      
      // æª¢æŸ¥è³‡æ–™æ™‚æ•ˆæ€§ï¼ˆ7 å¤©ï¼‰
      const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 å¤©
      if (Date.now() - storageObject.timestamp > maxAge) {
        SecurityLogger.logEvent('EXPIRED_DATA_ACCESS', { key, age: Date.now() - storageObject.timestamp });
        this.removeItem(key);
        return null;
      }
      
      return storageObject.data;
      
    } catch (error) {
      SecurityLogger.logStorageError('GET_ITEM_FAILED', { key, error: error.message });
      return null;
    }
  }
  
  /**
   * é©—è­‰å„²å­˜è³‡æ–™çš„åˆæ³•æ€§
   * @param {any} data - å¾…é©—è­‰çš„è³‡æ–™
   * @returns {any} é©—è­‰å¾Œçš„è³‡æ–™
   */
  static validateStorageData(data) {
    if (data === null || data === undefined) {
      return data;
    }
    
    // éŠæˆ²åˆ†æ•¸é©—è­‰
    if (data.score !== undefined) {
      data.score = SecurityValidator.validateScore(data.score);
    }
    
    // æ’è¡Œæ¦œè³‡æ–™é©—è­‰
    if (data.leaderboard && Array.isArray(data.leaderboard)) {
      data.leaderboard = data.leaderboard
        .filter(entry => entry && typeof entry === 'object')
        .slice(0, 100) // é™åˆ¶æ’è¡Œæ¦œæ¢ç›®æ•¸é‡
        .map(entry => ({
          score: SecurityValidator.validateScore(entry.score),
          mode: SecurityValidator.sanitizeInput(entry.mode),
          date: entry.date,
          duration: typeof entry.duration === 'number' ? entry.duration : 30
        }));
    }
    
    return data;
  }
  
  /**
   * è¨ˆç®—è³‡æ–™æ ¡é©—å’Œ
   * @param {any} data - åŸå§‹è³‡æ–™
   * @returns {string} æ ¡é©—å’Œ
   */
  static calculateChecksum(data) {
    const str = JSON.stringify(data);
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash; // è½‰ç‚º 32 ä½æ•´æ•¸
    }
    return hash.toString(16);
  }
  
  /**
   * é©—è­‰æ ¡é©—å’Œ
   * @param {any} data - è³‡æ–™
   * @param {string} checksum - æ ¡é©—å’Œ
   * @returns {boolean} é©—è­‰çµæœ
   */
  static verifyChecksum(data, checksum) {
    return this.calculateChecksum(data) === checksum;
  }
}
```

### æ•æ„Ÿè³‡è¨Šè™•ç†

```javascript
// âœ… æ•æ„Ÿè³‡è¨Šè™•ç†åŸå‰‡
class SensitiveDataHandler {
  // âŒ ç¦æ­¢å„²å­˜çš„æ•æ„Ÿè³‡è¨Š
  static FORBIDDEN_DATA = [
    'password', 'token', 'apiKey', 'secretKey',
    'personalInfo', 'email', 'phoneNumber'
  ];
  
  /**
   * æª¢æŸ¥æ˜¯å¦åŒ…å«æ•æ„Ÿè³‡è¨Š
   * @param {any} data - å¾…æª¢æŸ¥çš„è³‡æ–™
   * @returns {boolean} æ˜¯å¦å®‰å…¨
   */
  static isSafeToStore(data) {
    const dataStr = JSON.stringify(data).toLowerCase();
    
    return !this.FORBIDDEN_DATA.some(forbidden => 
      dataStr.includes(forbidden)
    );
  }
  
  /**
   * æ¸…ç†æ½›åœ¨æ•æ„Ÿè³‡è¨Š
   * @param {any} data - åŸå§‹è³‡æ–™
   * @returns {any} æ¸…ç†å¾Œçš„è³‡æ–™
   */
  static sanitizeData(data) {
    if (typeof data !== 'object' || data === null) {
      return data;
    }
    
    const cleaned = { ...data };
    
    // ç§»é™¤æ•æ„Ÿæ¬„ä½
    this.FORBIDDEN_DATA.forEach(key => {
      delete cleaned[key];
    });
    
    return cleaned;
  }
}
```

## ğŸ” åŠ å¯†èˆ‡ç·¨ç¢¼

### ç°¡å–®åŠ å¯†å¯¦ä½œ

```javascript
// âœ… åŸºç¤åŠ å¯†åŠŸèƒ½ï¼ˆåƒ…ç”¨æ–¼æ··æ·†ï¼Œéå®‰å…¨åŠ å¯†ï¼‰
class BasicEncryption {
  /**
   * ç°¡å–® XOR ç·¨ç¢¼ï¼ˆç”¨æ–¼è³‡æ–™æ··æ·†ï¼‰
   * @param {string} text - åŸå§‹æ–‡å­—
   * @param {string} key - ç·¨ç¢¼éµå€¼
   * @returns {string} ç·¨ç¢¼å¾Œçš„æ–‡å­—
   */
  static encode(text, key = 'clickfun2025') {
    let result = '';
    for (let i = 0; i < text.length; i++) {
      const textChar = text.charCodeAt(i);
      const keyChar = key.charCodeAt(i % key.length);
      result += String.fromCharCode(textChar ^ keyChar);
    }
    return btoa(result); // Base64 ç·¨ç¢¼
  }
  
  /**
   * ç°¡å–® XOR è§£ç¢¼
   * @param {string} encodedText - ç·¨ç¢¼å¾Œçš„æ–‡å­—
   * @param {string} key - ç·¨ç¢¼éµå€¼
   * @returns {string} åŸå§‹æ–‡å­—
   */
  static decode(encodedText, key = 'clickfun2025') {
    try {
      const decodedBase64 = atob(encodedText);
      let result = '';
      for (let i = 0; i < decodedBase64.length; i++) {
        const textChar = decodedBase64.charCodeAt(i);
        const keyChar = key.charCodeAt(i % key.length);
        result += String.fromCharCode(textChar ^ keyChar);
      }
      return result;
    } catch (error) {
      SecurityLogger.logSecurityEvent('DECODE_FAILED', { error: error.message });
      return '';
    }
  }
}
```

## ğŸš¨ å®‰å…¨ç›£æ§èˆ‡æ—¥èªŒ

### å®‰å…¨äº‹ä»¶è¨˜éŒ„

```javascript
// âœ… å®‰å…¨æ—¥èªŒç³»çµ±
class SecurityLogger {
  /**
   * è¨˜éŒ„å®‰å…¨äº‹ä»¶
   * @param {string} eventType - äº‹ä»¶é¡å‹
   * @param {object} details - äº‹ä»¶è©³æƒ…
   */
  static logSecurityEvent(eventType, details = {}) {
    const securityEvent = {
      type: 'SECURITY_EVENT',
      eventType,
      details,
      timestamp: new Date().toISOString(),
      userAgent: navigator.userAgent,
      url: window.location.href,
      sessionId: this.getSessionId()
    };
    
    // è¨˜éŒ„åˆ°æ§åˆ¶å°ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
    if (process.env.NODE_ENV === 'development') {
      console.warn('ğŸš¨ å®‰å…¨äº‹ä»¶:', securityEvent);
    }
    
    // è¨˜éŒ„åˆ°åˆ†æç³»çµ±ï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰
    if (typeof gtag !== 'undefined') {
      gtag('event', 'security_incident', {
        event_category: 'security',
        event_label: eventType,
        custom_parameter: JSON.stringify(details)
      });
    }
    
    // å„²å­˜åˆ°æœ¬åœ°ï¼ˆç”¨æ–¼èª¿è©¦ï¼‰
    this.storeSecurityLog(securityEvent);
  }
  
  /**
   * è¨˜éŒ„å¯ç–‘æ´»å‹•
   * @param {string} activity - æ´»å‹•é¡å‹
   * @param {object} context - ä¸Šä¸‹æ–‡è³‡è¨Š
   */
  static logSuspiciousActivity(activity, context = {}) {
    const suspiciousEvent = {
      type: 'SUSPICIOUS_ACTIVITY',
      activity,
      context,
      riskLevel: this.assessRiskLevel(activity, context),
      timestamp: new Date().toISOString(),
      sessionInfo: this.getSessionInfo()
    };
    
    this.logSecurityEvent('SUSPICIOUS_ACTIVITY', suspiciousEvent);
    
    // é«˜é¢¨éšªæ´»å‹•ç«‹å³è­¦å‘Š
    if (suspiciousEvent.riskLevel === 'HIGH') {
      console.error('ğŸš¨ é«˜é¢¨éšªæ´»å‹•æª¢æ¸¬:', suspiciousEvent);
    }
  }
  
  /**
   * è©•ä¼°é¢¨éšªç­‰ç´š
   * @param {string} activity - æ´»å‹•é¡å‹
   * @param {object} context - ä¸Šä¸‹æ–‡
   * @returns {string} é¢¨éšªç­‰ç´š
   */
  static assessRiskLevel(activity, context) {
    const highRiskActivities = [
      'UNREASONABLE_SCORE', 'DATA_CORRUPTION', 'INVALID_INPUT'
    ];
    
    const mediumRiskActivities = [
      'REPEATED_ERRORS', 'UNUSUAL_BEHAVIOR'
    ];
    
    if (highRiskActivities.includes(activity)) {
      return 'HIGH';
    } else if (mediumRiskActivities.includes(activity)) {
      return 'MEDIUM';
    } else {
      return 'LOW';
    }
  }
  
  /**
   * å„²å­˜å®‰å…¨æ—¥èªŒ
   * @param {object} logEntry - æ—¥èªŒæ¢ç›®
   */
  static storeSecurityLog(logEntry) {
    try {
      const logs = JSON.parse(localStorage.getItem('clickfun_security_logs') || '[]');
      logs.push(logEntry);
      
      // åªä¿ç•™æœ€è¿‘ 100 æ¢æ—¥èªŒ
      const recentLogs = logs.slice(-100);
      localStorage.setItem('clickfun_security_logs', JSON.stringify(recentLogs));
    } catch (error) {
      console.error('å®‰å…¨æ—¥èªŒå„²å­˜å¤±æ•—:', error);
    }
  }
  
  /**
   * ç²å–æœƒè©± ID
   * @returns {string} æœƒè©± ID
   */
  static getSessionId() {
    let sessionId = sessionStorage.getItem('clickfun_session_id');
    if (!sessionId) {
      sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      sessionStorage.setItem('clickfun_session_id', sessionId);
    }
    return sessionId;
  }
}
```

## ğŸ” å®‰å…¨æ¸¬è©¦

### å®‰å…¨æ¸¬è©¦æª¢æŸ¥æ¸…å–®

```javascript
// âœ… å®‰å…¨æ¸¬è©¦å¥—ä»¶
describe('å®‰å…¨æ€§æ¸¬è©¦', () => {
  describe('è¼¸å…¥é©—è­‰', () => {
    test('æ‡‰è©²æ‹’çµ•éæ•¸å­—åˆ†æ•¸', () => {
      expect(() => {
        SecurityValidator.validateScore('100');
      }).toThrow('åˆ†æ•¸å¿…é ˆæ˜¯æ•¸å­—');
    });
    
    test('æ‡‰è©²æ‹’çµ•è² æ•¸åˆ†æ•¸', () => {
      expect(() => {
        SecurityValidator.validateScore(-10);
      }).toThrow('åˆ†æ•¸ä¸èƒ½ç‚ºè² æ•¸');
    });
    
    test('æ‡‰è©²æ‹’çµ•éé«˜åˆ†æ•¸', () => {
      expect(() => {
        SecurityValidator.validateScore(99999);
      }).toThrow('åˆ†æ•¸è¶…å‡ºåˆç†ç¯„åœ');
    });
  });
  
  describe('XSS é˜²è­·', () => {
    test('æ‡‰è©²æ¸…ç† HTML æ¨™ç±¤', () => {
      const maliciousInput = '<script>alert("XSS")</script>Hello';
      const sanitized = SecurityValidator.sanitizeInput(maliciousInput);
      expect(sanitized).toBe('Hello');
      expect(sanitized).not.toContain('<script>');
    });
    
    test('æ‡‰è©²æ¸…ç† JavaScript å”è­°', () => {
      const maliciousInput = 'javascript:alert("XSS")';
      const sanitized = SecurityValidator.sanitizeInput(maliciousInput);
      expect(sanitized).not.toContain('javascript:');
    });
  });
  
  describe('è³‡æ–™å®Œæ•´æ€§', () => {
    test('æ‡‰è©²æª¢æ¸¬è³‡æ–™ç¯¡æ”¹', () => {
      const originalData = { score: 100 };
      const checksum = SecureStorage.calculateChecksum(originalData);
      const tamperedData = { score: 999 };
      
      expect(SecureStorage.verifyChecksum(tamperedData, checksum)).toBe(false);
    });
  });
});
```

## ğŸ“‹ å®‰å…¨æª¢æŸ¥æ¸…å–®

### æ¯æ¬¡ç™¼å¸ƒå‰æª¢æŸ¥

- [ ] **è¼¸å…¥é©—è­‰**: æ‰€æœ‰ç”¨æˆ¶è¼¸å…¥éƒ½ç¶“éé©—è­‰å’Œæ¸…ç†
- [ ] **XSS é˜²è­·**: ä¸ä½¿ç”¨ innerHTMLï¼Œä½¿ç”¨ textContent
- [ ] **CSP è¨­å®š**: Content Security Policy æ­£ç¢ºé…ç½®
- [ ] **è³‡æ–™åŠ å¯†**: æ•æ„Ÿè³‡æ–™é©ç•¶è™•ç†
- [ ] **éŒ¯èª¤è™•ç†**: ä¸æ´©éœ²æ•æ„Ÿè³‡è¨Šçš„éŒ¯èª¤è¨Šæ¯
- [ ] **æ—¥èªŒè¨˜éŒ„**: å®‰å…¨äº‹ä»¶æ­£ç¢ºè¨˜éŒ„
- [ ] **ä¾è³´æª¢æŸ¥**: ç¬¬ä¸‰æ–¹å¥—ä»¶ç„¡å·²çŸ¥æ¼æ´

### å®šæœŸå®‰å…¨å¯©æŸ¥

```yaml
security_review_schedule:
  code_review: "æ¯æ¬¡ PR"
  vulnerability_scan: "æ¯é€±"
  dependency_audit: "æ¯æœˆ"
  security_testing: "æ¯æ¬¡ç™¼å¸ƒ"
  penetration_testing: "æ¯å­£"
```

---

**ğŸ”’ å®‰å…¨ç›®æ¨™**: é›¶å·²çŸ¥å®‰å…¨æ¼æ´ï¼Œä¿è­·ç”¨æˆ¶è³‡æ–™å®‰å…¨  
**ğŸ›¡ï¸ é˜²è­·ç­‰ç´š**: ä¼æ¥­ç´šå®‰å…¨æ¨™æº–  
**ğŸ“Š ç›£æ§è¦†è“‹**: 100% é—œéµåŠŸèƒ½å®‰å…¨ç›£æ§